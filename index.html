<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rajani Food's - Billing Software</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            color: #667eea;
            font-size: 28px;
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 10px 20px;
            background: #f0f0f0;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .tab-btn:hover {
            background: #667eea;
            color: white;
        }

        .tab-btn.active {
            background: #667eea;
            color: white;
        }

        .content-area {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            min-height: 600px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
        }

        input, select, textarea {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 14px;
            transition: border 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            font-weight: 600;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        .btn-secondary {
            background: #718096;
            color: white;
        }

        .item-list {
            margin: 20px 0;
        }

        .item-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 80px;
            gap: 10px;
            margin-bottom: 10px;
            align-items: end;
        }

        .order-summary {
            background: #f7fafc;
            padding: 20px;
            border-radius: 5px;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }

        tr:hover {
            background: #f7fafc;
        }

        .card {
            background: #f7fafc;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            margin: 10px 0;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .search-box {
            margin-bottom: 20px;
        }

        .search-box input {
            width: 100%;
            max-width: 400px;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: #c6f6d5;
            color: #22543d;
        }

        .badge-warning {
            background: #feebc8;
            color: #744210;
        }

        .badge-danger {
            background: #fed7d7;
            color: #742a2a;
        }

        .invoice {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 40px;
        }

        .invoice-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 20px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #48bb78;
            color: white;
            padding: 15px 20px;
            border-radius: 5px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            display: none;
            z-index: 1000;
        }

        .notification.show {
            display: block;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .low-stock {
            background: #fed7d7;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üçΩÔ∏è Rajani Food's Billing System</h1>
            <div style="text-align: right;">
                <div id="currentDate" style="font-size: 14px; color: #666;"></div>
                <div id="todayOrders" style="font-size: 12px; color: #667eea; font-weight: 600;"></div>
            </div>
        </header>

        <nav class="nav-tabs">
            <button class="tab-btn active" onclick="switchTab('orders')">üìã New Order</button>
            <button class="tab-btn" onclick="switchTab('inventory')">üì¶ Inventory</button>
            <button class="tab-btn" onclick="switchTab('rawmaterials')">ü•¨ Raw Materials</button>
            <button class="tab-btn" onclick="switchTab('utensils')">üç¥ Utensils</button>
            <button class="tab-btn" onclick="switchTab('payments')">üí∞ Payments</button>
            <button class="tab-btn" onclick="switchTab('customers')">üë• Customers</button>
            <button class="tab-btn" onclick="switchTab('reports')">üìä Reports</button>
        </nav>

        <div class="content-area">
            <!-- Orders Tab -->
            <div id="orders" class="tab-content active">
                <h2 style="margin-bottom: 20px;">Create New Order</h2>
                <form id="orderForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Customer Name *</label>
                            <input type="text" id="customerName" required>
                        </div>
                        <div class="form-group">
                            <label>Phone Number *</label>
                            <input type="tel" id="phoneNumber" required pattern="[0-9]{10}">
                        </div>
                        <div class="form-group">
                            <label>Order Date *</label>
                            <input type="date" id="orderDate" required>
                        </div>
                        <div class="form-group">
                            <label>Order Time *</label>
                            <input type="time" id="orderTime" required>
                        </div>
                        <div class="form-group">
                            <label>Order Type *</label>
                            <select id="orderType" required>
                                <option value="delivery">Delivery</option>
                                <option value="pickup">Pickup</option>
                            </select>
                        </div>
                    </div>

                    <h3 style="margin: 20px 0;">Order Items</h3>
                    <div class="item-list" id="itemList">
                        <div class="item-row">
                            <div class="form-group">
                                <label>Item Name</label>
                                <input type="text" class="item-name" placeholder="e.g., Thali, Sabzi">
                            </div>
                            <div class="form-group">
                                <label>Quantity</label>
                                <input type="number" class="item-qty" value="1" min="1">
                            </div>
                            <div class="form-group">
                                <label>Price (‚Çπ)</label>
                                <input type="number" class="item-price" value="0" min="0">
                            </div>
                            <div class="form-group">
                                <label>Total</label>
                                <input type="number" class="item-total" readonly>
                            </div>
                            <div class="form-group">
                                <label>&nbsp;</label>
                                <button type="button" class="btn btn-danger" onclick="removeItem(this)">‚úï</button>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="addItem()">+ Add Item</button>

                    <div class="form-group" style="margin-top: 20px;">
                        <label>Special Instructions / Customization</label>
                        <textarea id="orderNotes" rows="3" placeholder="Any special requests or customization..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>Utensils Provided</label>
                        <input type="text" id="utensilsProvided" placeholder="e.g., 2 plates, 3 bowls">
                    </div>

                    <div class="order-summary">
                        <h3>Order Summary</h3>
                        <p><strong>Subtotal:</strong> ‚Çπ<span id="subtotal">0</span></p>
                        <p><strong>Tax (5%):</strong> ‚Çπ<span id="tax">0</span></p>
                        <p style="font-size: 20px; color: #667eea;"><strong>Total:</strong> ‚Çπ<span id="total">0</span></p>
                    </div>

                    <div class="action-buttons">
                        <button type="submit" class="btn btn-primary">Create Order & Generate Bill</button>
                        <button type="button" class="btn btn-secondary" onclick="resetForm()">Reset</button>
                    </div>
                </form>
            </div>

            <!-- Inventory Tab -->
            <div id="inventory" class="tab-content">
                <h2 style="margin-bottom: 20px;">Inventory Management</h2>
                <button class="btn btn-primary" onclick="showAddInventory()">+ Add Inventory Item</button>
                
                <div class="search-box" style="margin-top: 20px;">
                    <input type="text" id="inventorySearch" placeholder="Search inventory..." onkeyup="searchInventory()">
                </div>

                <table id="inventoryTable">
                    <thead>
                        <tr>
                            <th>Item Name</th>
                            <th>Current Stock</th>
                            <th>Unit</th>
                            <th>Min Level</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="inventoryBody">
                    </tbody>
                </table>
            </div>

            <!-- Raw Materials Tab -->
            <div id="rawmaterials" class="tab-content">
                <h2 style="margin-bottom: 20px;">Raw Materials Mapping</h2>
                <button class="btn btn-primary" onclick="showAddRawMaterial()">+ Add Raw Material Mapping</button>
                
                <table style="margin-top: 20px;">
                    <thead>
                        <tr>
                            <th>Menu Item</th>
                            <th>Raw Materials Required</th>
                            <th>Quantity Per Unit</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="rawMaterialsBody">
                    </tbody>
                </table>
            </div>

            <!-- Utensils Tab -->
            <div id="utensils" class="tab-content">
                <h2 style="margin-bottom: 20px;">Utensil Tracking</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Total Utensils Out</div>
                        <div class="stat-value" id="totalUtensilsOut">0</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #f56565 0%, #c53030 100%);">
                        <div class="stat-label">Pending Returns</div>
                        <div class="stat-value" id="pendingReturns">0</div>
                    </div>
                </div>

                <table>
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Customer</th>
                            <th>Utensils Given</th>
                            <th>Date</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="utensilsBody">
                    </tbody>
                </table>
            </div>

            <!-- Payments Tab -->
            <div id="payments" class="tab-content">
                <h2 style="margin-bottom: 20px;">Payment & Ledger</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Total Received</div>
                        <div class="stat-value">‚Çπ<span id="totalReceived">0</span></div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #f56565 0%, #c53030 100%);">
                        <div class="stat-label">Total Due</div>
                        <div class="stat-value">‚Çπ<span id="totalDue">0</span></div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);">
                        <div class="stat-label">Partial Payments</div>
                        <div class="stat-value" id="partialPayments">0</div>
                    </div>
                </div>

                <div class="search-box">
                    <input type="text" id="paymentSearch" placeholder="Search by customer or order ID..." onkeyup="searchPayments()">
                </div>

                <table>
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Customer</th>
                            <th>Total Amount</th>
                            <th>Paid</th>
                            <th>Due</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="paymentsBody">
                    </tbody>
                </table>
            </div>

            <!-- Customers Tab -->
            <div id="customers" class="tab-content">
                <h2 style="margin-bottom: 20px;">Customer & Order History</h2>
                
                <div class="search-box">
                    <input type="text" id="customerSearch" placeholder="Search customers..." onkeyup="searchCustomers()">
                </div>

                <table>
                    <thead>
                        <tr>
                            <th>Customer Name</th>
                            <th>Phone</th>
                            <th>Total Orders</th>
                            <th>Total Spent</th>
                            <th>Last Order</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="customersBody">
                    </tbody>
                </table>
            </div>

            <!-- Reports Tab -->
            <div id="reports" class="tab-content">
                <h2 style="margin-bottom: 20px;">Reports & Analytics</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Today's Sales</div>
                        <div class="stat-value">‚Çπ<span id="todaySales">0</span></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">This Week</div>
                        <div class="stat-value">‚Çπ<span id="weekSales">0</span></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">This Month</div>
                        <div class="stat-value">‚Çπ<span id="monthSales">0</span></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Orders</div>
                        <div class="stat-value" id="totalOrders">0</div>
                    </div>
                </div>

                <div class="card">
                    <h3>Today's Orders</h3>
                    <div id="todayOrdersList"></div>
                </div>

                <div class="card">
                    <h3>Low Inventory Items</h3>
                    <div id="lowInventoryList"></div>
                </div>

                <div class="card">
                    <h3>Pending Payments</h3>
                    <div id="pendingPaymentsList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <!-- Modals -->
    <div class="modal" id="inventoryModal">
        <div class="modal-content">
            <h3>Add Inventory Item</h3>
            <form id="inventoryForm">
                <div class="form-group">
                    <label>Item Name</label>
                    <input type="text" id="invItemName" required>
                </div>
                <div class="form-group">
                    <label>Current Stock</label>
                    <input type="number" id="invStock" required>
                </div>
                <div class="form-group">
                    <label>Unit</label>
                    <select id="invUnit">
                        <option>kg</option>
                        <option>liter</option>
                        <option>pieces</option>
                        <option>packets</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Minimum Level</label>
                    <input type="number" id="invMinLevel" required>
                </div>
                <div class="action-buttons">
                    <button type="submit" class="btn btn-success">Save</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('inventoryModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="rawMaterialModal">
        <div class="modal-content">
            <h3>Add Raw Material Mapping</h3>
            <form id="rawMaterialForm">
                <div class="form-group">
                    <label>Menu Item</label>
                    <input type="text" id="rmMenuItem" required>
                </div>
                <div class="form-group">
                    <label>Raw Materials (comma separated)</label>
                    <input type="text" id="rmMaterials" placeholder="e.g., Rice, Dal, Oil" required>
                </div>
                <div class="form-group">
                    <label>Quantities (comma separated)</label>
                    <input type="text" id="rmQuantities" placeholder="e.g., 200g, 100g, 50ml" required>
                </div>
                <div class="action-buttons">
                    <button type="submit" class="btn btn-success">Save</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('rawMaterialModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="paymentModal">
        <div class="modal-content">
            <h3>Record Payment</h3>
            <form id="paymentForm">
                <input type="hidden" id="paymentOrderId">
                <div class="form-group">
                    <label>Amount to Pay</label>
                    <input type="number" id="paymentAmount" required>
                </div>
                <div class="form-group">
                    <label>Payment Method</label>
                    <select id="paymentMethod">
                        <option>Cash</option>
                        <option>Card</option>
                        <option>UPI</option>
                        <option>Bank Transfer</option>
                    </select>
                </div>
                <div class="action-buttons">
                    <button type="submit" class="btn btn-success">Record Payment</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('paymentModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="invoiceModal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="invoice" id="invoiceContent">
                <!-- Invoice will be generated here -->
            </div>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="printInvoice()">üñ®Ô∏è Print</button>
                <button class="btn btn-success" onclick="downloadPDF()">üìÑ Download PDF</button>
                <button class="btn btn-secondary" onclick="closeModal('invoiceModal')">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Data Storage
        let orders = JSON.parse(localStorage.getItem('orders') || '[]');
        let inventory = JSON.parse(localStorage.getItem('inventory') || '[]');
        let rawMaterials = JSON.parse(localStorage.getItem('rawMaterials') || '[]');
        let customers = JSON.parse(localStorage.getItem('customers') || '[]');

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateDateTime();
            setInterval(updateDateTime, 60000);
            
            // Set default date and time
            const now = new Date();
            document.getElementById('orderDate').valueAsDate = now;
            document.getElementById('orderTime').value = now.toTimeString().slice(0,5);
            
            // Load initial data
            loadInventory();
            loadRawMaterials();
            loadUtensils();
            loadPayments();
            loadCustomers();
            loadReports();
            
            // Add sample data if empty
            if (inventory.length === 0) {
                addSampleData();
            }
        });

        function updateDateTime() {
            const now = new Date();
            document.getElementById('currentDate').textContent = now.toLocaleDateString('en-IN', {
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
            });
            
            const todayOrders = orders.filter(o => {
                const orderDate = new Date(o.date);
                return orderDate.toDateString() === now.toDateString();
            }).length;
            
            document.getElementById('todayOrders').textContent = `Today's Orders: ${todayOrders}`;
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            // Refresh data when switching tabs
            if (tabName === 'inventory') loadInventory();
            if (tabName === 'rawmaterials') loadRawMaterials();
            if (tabName === 'utensils') loadUtensils();
            if (tabName === 'payments') loadPayments();
            if (tabName === 'customers') loadCustomers();
            if (tabName === 'reports') loadReports();
        }

        // Order Management
        function addItem() {
            const itemList = document.getElementById('itemList');
            const newRow = document.createElement('div');
            newRow.className = 'item-row';
            newRow.innerHTML = `
                <div class="form-group">
                    <input type="text" class="item-name" placeholder="e.g., Thali, Sabzi">
                </div>
                <div class="form-group">
                    <input type="number" class="item-qty" value="1" min="1" onchange="calculateItemTotal(this)">
                </div>
                <div class="form-group">
                    <input type="number" class="item-price" value="0" min="0" onchange="calculateItemTotal(this)">
                </div>
                <div class="form-group">
                    <input type="number" class="item-total" readonly>
                </div>
                <div class="form-group">
                    <button type="button" class="btn btn-danger" onclick="removeItem(this)">‚úï</button>
                </div>
            `;
            itemList.appendChild(newRow);
        }

        function removeItem(btn) {
            btn.closest('.item-row').remove();
            calculateOrderTotal();
        }

        function calculateItemTotal(input) {
            const row = input.closest('.item-row');
            const qty = parseFloat(row.querySelector('.item-qty').value) || 0;
            const price = parseFloat(row.querySelector('.item-price').value) || 0;
            row.querySelector('.item-total').value = (qty * price).toFixed(2);
            calculateOrderTotal();
        }

        function calculateOrderTotal() {
            let subtotal = 0;
            document.querySelectorAll('.item-total').forEach(input => {
                subtotal += parseFloat(input.value) || 0;
            });
            
            const tax = subtotal * 0.05;
            const total = subtotal + tax;
            
            document.getElementById('subtotal').textContent = subtotal.toFixed(2);
            document.getElementById('tax').textContent = tax.toFixed(2);
            document.getElementById('total').textContent = total.toFixed(2);
        }

        // Auto-calculate on input
        document.addEventListener('input', function(e) {
            if (e.target.classList.contains('item-qty') || e.target.classList.contains('item-price')) {
                calculateItemTotal(e.target);
            }
        });

        document.getElementById('orderForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const items = [];
            document.querySelectorAll('.item-row').forEach(row => {
                const name = row.querySelector('.item-name').value;
                const qty = parseFloat(row.querySelector('.item-qty').value);
                const price = parseFloat(row.querySelector('.item-price').value);
                if (name && qty && price) {
                    items.push({ name, qty, price, total: qty * price });
                }
            });
            
            if (items.length === 0) {
                showNotification('Please add at least one item', 'error');
                return;
            }
            
            const orderId = 'ORD' + Date.now();
            const subtotal = parseFloat(document.getElementById('subtotal').textContent);
            const tax = parseFloat(document.getElementById('tax').textContent);
            const total = parseFloat(document.getElementById('total').textContent);
            
            const order = {
                id: orderId,
                customerName: document.getElementById('customerName').value,
                phone: document.getElementById('phoneNumber').value,
                date: document.getElementById('orderDate').value,
                time: document.getElementById('orderTime').value,
                type: document.getElementById('orderType').value,
                items: items,
                notes: document.getElementById('orderNotes').value,
                utensils: document.getElementById('utensilsProvided').value,
                subtotal: subtotal,
                tax: tax,
                total: total,
                paid: 0,
                due: total,
                status: 'pending',
                createdAt: new Date().toISOString()
            };
            
            orders.push(order);
            localStorage.setItem('orders', JSON.stringify(orders));
            
            // Update customer data
            updateCustomerData(order);
            
            // Deduct raw materials
            deductRawMaterials(items);
            
            showNotification('Order created successfully!');
            generateInvoice(order);
            resetForm();
        });

        function updateCustomerData(order) {
            let customer = customers.find(c => c.phone === order.phone);
            if (customer) {
                customer.totalOrders++;
                customer.totalSpent += order.total;
                customer.lastOrder = order.date;
                customer.orders.push(order.id);
            } else {
                customers.push({
                    name: order.customerName,
                    phone: order.phone,
                    totalOrders: 1,
                    totalSpent: order.total,
                    lastOrder: order.date,
                    orders: [order.id]
                });
            }
            localStorage.setItem('customers', JSON.stringify(customers));
        }

        function deductRawMaterials(items) {
            items.forEach(item => {
                const mapping = rawMaterials.find(rm => rm.menuItem.toLowerCase() === item.name.toLowerCase());
                if (mapping) {
                    mapping.materials.forEach((material, idx) => {
                        const invItem = inventory.find(i => i.name.toLowerCase() === material.toLowerCase());
                        if (invItem) {
                            const qtyNeeded = parseFloat(mapping.quantities[idx]) * item.qty;
                            invItem.stock -= qtyNeeded;
                        }
                    });
                }
            });
            localStorage.setItem('inventory', JSON.stringify(inventory));
        }

        function generateInvoice(order) {
            const invoice = `
                <div class="invoice-header">
                    <div>
                        <h2 style="color: #667eea;">RAJANI FOOD'S</h2>
                        <p>Premium Food Service</p>
                        <p>Phone: +91 98765 43210</p>
                    </div>
                    <div style="text-align: right;">
                        <h3>INVOICE</h3>
                        <p><strong>Order ID:</strong> ${order.id}</p>
                        <p><strong>Date:</strong> ${order.date}</p>
                        <p><strong>Time:</strong> ${order.time}</p>
                    </div>
                </div>
                
                <div style="margin-bottom: 30px;">
                    <h4>Bill To:</h4>
                    <p><strong>${order.customerName}</strong></p>
                    <p>Phone: ${order.phone}</p>
                    <p>Type: ${order.type.toUpperCase()}</p>
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>Quantity</th>
                            <th>Price</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${order.items.map(item => `
                            <tr>
                                <td>${item.name}</td>
                                <td>${item.qty}</td>
                                <td>‚Çπ${item.price.toFixed(2)}</td>
                                <td>‚Çπ${item.total.toFixed(2)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                
                <div style="margin-top: 30px; text-align: right;">
                    <p><strong>Subtotal:</strong> ‚Çπ${order.subtotal.toFixed(2)}</p>
                    <p><strong>Tax (5%):</strong> ‚Çπ${order.tax.toFixed(2)}</p>
                    <h3 style="color: #667eea; margin-top: 10px;">Total: ‚Çπ${order.total.toFixed(2)}</h3>
                </div>
                
                ${order.notes ? `<p style="margin-top: 20px;"><strong>Special Instructions:</strong> ${order.notes}</p>` : ''}
                ${order.utensils ? `<p><strong>Utensils Provided:</strong> ${order.utensils}</p>` : ''}
                
                <div style="margin-top: 40px; text-align: center; border-top: 2px solid #e0e0e0; padding-top: 20px;">
                    <p>Thank you for your order!</p>
                    <p style="font-size: 12px; color: #666;">This is a computer generated invoice</p>
                </div>
            `;
            
            document.getElementById('invoiceContent').innerHTML = invoice;
            document.getElementById('invoiceModal').classList.add('show');
        }

        function resetForm() {
            document.getElementById('orderForm').reset();
            const now = new Date();
            document.getElementById('orderDate').valueAsDate = now;
            document.getElementById('orderTime').value = now.toTimeString().slice(0,5);
            
            const itemList = document.getElementById('itemList');
            itemList.innerHTML = `
                <div class="item-row">
                    <div class="form-group">
                        <label>Item Name</label>
                        <input type="text" class="item-name" placeholder="e.g., Thali, Sabzi">
                    </div>
                    <div class="form-group">
                        <label>Quantity</label>
                        <input type="number" class="item-qty" value="1" min="1">
                    </div>
                    <div class="form-group">
                        <label>Price (‚Çπ)</label>
                        <input type="number" class="item-price" value="0" min="0">
                    </div>
                    <div class="form-group">
                        <label>Total</label>
                        <input type="number" class="item-total" readonly>
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button type="button" class="btn btn-danger" onclick="removeItem(this)">‚úï</button>
                    </div>
                </div>
            `;
            calculateOrderTotal();
        }

        // Inventory Management
        function showAddInventory() {
            document.getElementById('inventoryModal').classList.add('show');
        }

        document.getElementById('inventoryForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            inventory.push({
                name: document.getElementById('invItemName').value,
                stock: parseFloat(document.getElementById('invStock').value),
                unit: document.getElementById('invUnit').value,
                minLevel: parseFloat(document.getElementById('invMinLevel').value)
            });
            
            localStorage.setItem('inventory', JSON.stringify(inventory));
            loadInventory();
            closeModal('inventoryModal');
            this.reset();
            showNotification('Inventory item added successfully!');
        });

        function loadInventory() {
            const tbody = document.getElementById('inventoryBody');
            tbody.innerHTML = inventory.map((item, idx) => {
                const status = item.stock <= item.minLevel ? 
                    '<span class="badge badge-danger">Low Stock</span>' : 
                    '<span class="badge badge-success">In Stock</span>';
                const rowClass = item.stock <= item.minLevel ? 'low-stock' : '';
                
                return `
                    <tr class="${rowClass}">
                        <td>${item.name}</td>
                        <td>${item.stock}</td>
                        <td>${item.unit}</td>
                        <td>${item.minLevel}</td>
                        <td>${status}</td>
                        <td>
                            <button class="btn btn-secondary" style="padding: 5px 10px; font-size: 12px;" onclick="updateStock(${idx})">Update</button>
                            <button class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;" onclick="deleteInventory(${idx})">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateStock(idx) {
            const newStock = prompt('Enter new stock quantity:', inventory[idx].stock);
            if (newStock !== null) {
                inventory[idx].stock = parseFloat(newStock);
                localStorage.setItem('inventory', JSON.stringify(inventory));
                loadInventory();
                showNotification('Stock updated successfully!');
            }
        }

        function deleteInventory(idx) {
            if (confirm('Are you sure you want to delete this item?')) {
                inventory.splice(idx, 1);
                localStorage.setItem('inventory', JSON.stringify(inventory));
                loadInventory();
                showNotification('Item deleted successfully!');
            }
        }

        function searchInventory() {
            const search = document.getElementById('inventorySearch').value.toLowerCase();
            const rows = document.querySelectorAll('#inventoryBody tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        }

        // Raw Materials
        function showAddRawMaterial() {
            document.getElementById('rawMaterialModal').classList.add('show');
        }

        document.getElementById('rawMaterialForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            rawMaterials.push({
                menuItem: document.getElementById('rmMenuItem').value,
                materials: document.getElementById('rmMaterials').value.split(',').map(m => m.trim()),
                quantities: document.getElementById('rmQuantities').value.split(',').map(q => q.trim())
            });
            
            localStorage.setItem('rawMaterials', JSON.stringify(rawMaterials));
            loadRawMaterials();
            closeModal('rawMaterialModal');
            this.reset();
            showNotification('Raw material mapping added!');
        });

        function loadRawMaterials() {
            const tbody = document.getElementById('rawMaterialsBody');
            tbody.innerHTML = rawMaterials.map((item, idx) => `
                <tr>
                    <td>${item.menuItem}</td>
                    <td>${item.materials.join(', ')}</td>
                    <td>${item.quantities.join(', ')}</td>
                    <td>
                        <button class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;" onclick="deleteRawMaterial(${idx})">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function deleteRawMaterial(idx) {
            if (confirm('Delete this mapping?')) {
                rawMaterials.splice(idx, 1);
                localStorage.setItem('rawMaterials', JSON.stringify(rawMaterials));
                loadRawMaterials();
                showNotification('Mapping deleted!');
            }
        }

        // Utensils
        function loadUtensils() {
            const utensilOrders = orders.filter(o => o.utensils);
            const pending = utensilOrders.filter(o => o.status !== 'returned');
            
            document.getElementById('totalUtensilsOut').textContent = utensilOrders.length;
            document.getElementById('pendingReturns').textContent = pending.length;
            
            const tbody = document.getElementById('utensilsBody');
            tbody.innerHTML = utensilOrders.map(order => {
                const status = order.status === 'returned' ? 
                    '<span class="badge badge-success">Returned</span>' : 
                    '<span class="badge badge-warning">Pending</span>';
                
                return `
                    <tr>
                        <td>${order.id}</td>
                        <td>${order.customerName}</td>
                        <td>${order.utensils}</td>
                        <td>${order.date}</td>
                        <td>${status}</td>
                        <td>
                            ${order.status !== 'returned' ? 
                                `<button class="btn btn-success" style="padding: 5px 10px; font-size: 12px;" onclick="markReturned('${order.id}')">Mark Returned</button>` : 
                                ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function markReturned(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (order) {
                order.status = 'returned';
                localStorage.setItem('orders', JSON.stringify(orders));
                loadUtensils();
                showNotification('Utensils marked as returned!');
            }
        }

        // Payments
        function loadPayments() {
            const totalReceived = orders.reduce((sum, o) => sum + (o.paid || 0), 0);
            const totalDue = orders.reduce((sum, o) => sum + (o.due || 0), 0);
            const partialCount = orders.filter(o => o.paid > 0 && o.due > 0).length;
            
            document.getElementById('totalReceived').textContent = totalReceived.toFixed(2);
            document.getElementById('totalDue').textContent = totalDue.toFixed(2);
            document.getElementById('partialPayments').textContent = partialCount;
            
            const tbody = document.getElementById('paymentsBody');
            tbody.innerHTML = orders.map(order => {
                let status;
                if (order.due === 0) status = '<span class="badge badge-success">Paid</span>';
                else if (order.paid > 0) status = '<span class="badge badge-warning">Partial</span>';
                else status = '<span class="badge badge-danger">Unpaid</span>';
                
                return `
                    <tr>
                        <td>${order.id}</td>
                        <td>${order.customerName}</td>
                        <td>‚Çπ${order.total.toFixed(2)}</td>
                        <td>‚Çπ${order.paid.toFixed(2)}</td>
                        <td>‚Çπ${order.due.toFixed(2)}</td>
                        <td>${status}</td>
                        <td>
                            ${order.due > 0 ? 
                                `<button class="btn btn-success" style="padding: 5px 10px; font-size: 12px;" onclick="showPaymentModal('${order.id}')">Record Payment</button>` : 
                                ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function showPaymentModal(orderId) {
            document.getElementById('paymentOrderId').value = orderId;
            const order = orders.find(o => o.id === orderId);
            document.getElementById('paymentAmount').value = order.due;
            document.getElementById('paymentModal').classList.add('show');
        }

        document.getElementById('paymentForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const orderId = document.getElementById('paymentOrderId').value;
            const amount = parseFloat(document.getElementById('paymentAmount').value);
            const order = orders.find(o => o.id === orderId);
            
            if (order && amount <= order.due) {
                order.paid += amount;
                order.due -= amount;
                localStorage.setItem('orders', JSON.stringify(orders));
                loadPayments();
                closeModal('paymentModal');
                this.reset();
                showNotification('Payment recorded successfully!');
            } else {
                showNotification('Invalid payment amount!', 'error');
            }
        });

        function searchPayments() {
            const search = document.getElementById('paymentSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#paymentsBody tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        }

        // Customers
        function loadCustomers() {
            const tbody = document.getElementById('customersBody');
            tbody.innerHTML = customers.map(customer => `
                <tr>
                    <td>${customer.name}</td>
                    <td>${customer.phone}</td>
                    <td>${customer.totalOrders}</td>
                    <td>‚Çπ${customer.totalSpent.toFixed(2)}</td>
                    <td>${customer.lastOrder}</td>
                    <td>
                        <button class="btn btn-primary" style="padding: 5px 10px; font-size: 12px;" onclick="viewCustomerOrders('${customer.phone}')">View Orders</button>
                        <button class="btn btn-success" style="padding: 5px 10px; font-size: 12px;" onclick="repeatOrder('${customer.phone}')">Repeat Order</button>
                    </td>
                </tr>
            `).join('');
        }

        function viewCustomerOrders(phone) {
            const customer = customers.find(c => c.phone === phone);
            const customerOrders = orders.filter(o => o.phone === phone);
            
            let html = `<h3>${customer.name}'s Orders</h3>`;
            customerOrders.forEach(order => {
                html += `
                    <div class="card">
                        <p><strong>Order ID:</strong> ${order.id}</p>
                        <p><strong>Date:</strong> ${order.date} ${order.time}</p>
                        <p><strong>Total:</strong> ‚Çπ${order.total.toFixed(2)}</p>
                        <p><strong>Items:</strong> ${order.items.map(i => i.name).join(', ')}</p>
                    </div>
                `;
            });
            
            alert(html);
        }

        function repeatOrder(phone) {
            const customerOrders = orders.filter(o => o.phone === phone);
            if (customerOrders.length > 0) {
                const lastOrder = customerOrders[customerOrders.length - 1];
                document.getElementById('customerName').value = lastOrder.customerName;
                document.getElementById('phoneNumber').value = lastOrder.phone;
                document.getElementById('orderType').value = lastOrder.type;
                
                switchTab('orders');
                document.querySelector('[onclick="switchTab(\'orders\')"]').click();
                showNotification('Customer details loaded! Add items to create new order.');
            }
        }

        function searchCustomers() {
            const search = document.getElementById('customerSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#customersBody tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        }

        // Reports
        function loadReports() {
            const now = new Date();
            const todayOrders = orders.filter(o => {
                const orderDate = new Date(o.date);
                return orderDate.toDateString() === now.toDateString();
            });
            
            const todaySales = todayOrders.reduce((sum, o) => sum + o.total, 0);
            document.getElementById('todaySales').textContent = todaySales.toFixed(2);
            
            const weekStart = new Date(now);
            weekStart.setDate(now.getDate() - 7);
            const weekOrders = orders.filter(o => new Date(o.date) >= weekStart);
            const weekSales = weekOrders.reduce((sum, o) => sum + o.total, 0);
            document.getElementById('weekSales').textContent = weekSales.toFixed(2);
            
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            const monthOrders = orders.filter(o => new Date(o.date) >= monthStart);
            const monthSales = monthOrders.reduce((sum, o) => sum + o.total, 0);
            document.getElementById('monthSales').textContent = monthSales.toFixed(2);
            
            document.getElementById('totalOrders').textContent = orders.length;
            
            // Today's orders list
            const todayList = document.getElementById('todayOrdersList');
            todayList.innerHTML = todayOrders.length > 0 ? 
                todayOrders.map(o => `<p>‚Ä¢ ${o.customerName} - ‚Çπ${o.total.toFixed(2)} (${o.type})</p>`).join('') :
                '<p>No orders today</p>';
            
            // Low inventory
            const lowStock = inventory.filter(i => i.stock <= i.minLevel);
            const lowList = document.getElementById('lowInventoryList');
            lowList.innerHTML = lowStock.length > 0 ?
                lowStock.map(i => `<p>‚Ä¢ ${i.name} - ${i.stock} ${i.unit} (Min: ${i.minLevel})</p>`).join('') :
                '<p>All items adequately stocked</p>';
            
            // Pending payments
            const pendingOrders = orders.filter(o => o.due > 0);
            const pendingList = document.getElementById('pendingPaymentsList');
            pendingList.innerHTML = pendingOrders.length > 0 ?
                pendingOrders.map(o => `<p>‚Ä¢ ${o.customerName} - ‚Çπ${o.due.toFixed(2)} due</p>`).join('') :
                '<p>No pending payments</p>';
        }

        // Utilities
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.background = type === 'error' ? '#f56565' : '#48bb78';
            notification.classList.add('show');
            setTimeout(() => notification.classList.remove('show'), 3000);
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        function printInvoice() {
            const content = document.getElementById('invoiceContent').innerHTML;
            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write('<html><head><title>Invoice</title>');
            printWindow.document.write('<style>body{font-family:Arial;padding:20px;}table{width:100%;border-collapse:collapse;}th,td{border:1px solid #ddd;padding:8px;text-align:left;}th{background:#667eea;color:white;}</style>');
            printWindow.document.write('</head><body>');
            printWindow.document.write(content);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.print();
        }

        function downloadPDF() {
            showNotification('PDF download feature requires a PDF library. Use Print for now.');
        }

        // Add sample data
        function addSampleData() {
            inventory = [
                { name: 'Rice', stock: 50, unit: 'kg', minLevel: 10 },
                { name: 'Dal', stock: 30, unit: 'kg', minLevel: 10 },
                { name: 'Oil', stock: 15, unit: 'liter', minLevel: 5 },
                { name: 'Vegetables', stock: 25, unit: 'kg', minLevel: 10 },
                { name: 'Spices', stock: 8, unit: 'kg', minLevel: 5 }
            ];
            
            rawMaterials = [
                { menuItem: 'Thali', materials: ['Rice', 'Dal', 'Oil', 'Vegetables'], quantities: ['200g', '100g', '50ml', '150g'] },
                { menuItem: 'Sabzi', materials: ['Vegetables', 'Oil', 'Spices'], quantities: ['200g', '30ml', '20g'] }
            ];
            
            localStorage.setItem('inventory', JSON.stringify(inventory));
            localStorage.setItem('rawMaterials', JSON.stringify(rawMaterials));
            
            loadInventory();
            loadRawMaterials();
        }

        // Click outside modal to close
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('show');
            }
        }
    </script>
</body>
</html>